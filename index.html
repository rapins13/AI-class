<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì¡°ë³„ ìƒëŒ€í‰ê°€ Â· ì „ì²´ ì¡° ì¼ê´„ í‰ê°€ Â· ê´€ë¦¬ì í†µê³„</title>
  <style>
    body{font-family:sans-serif;margin:20px;background:#fafafa;color:#111}
    .wrap{max-width:1100px;margin:0 auto;}
    .card{background:#fff;border:1px solid #ccc;border-radius:12px;padding:16px;margin-bottom:16px}
    label{font-weight:600;display:block;margin:6px 0}
    input,select,textarea{padding:8px;border:1px solid #ccc;border-radius:8px}
    input#studentId{width:140px;}
    input#questionsCount{width:120px;text-align:right;}
    select,textarea{width:100%}
    .btn{padding:8px 14px;border-radius:8px;border:none;background:#333;color:#fff;font-weight:600;cursor:pointer}
    .btn[disabled]{background:#999}
    .row4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px}
    .topbar{position:fixed;top:10px;right:10px}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:#fff;padding:20px;border-radius:12px;width:320px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #ddd;padding:8px;text-align:center;vertical-align:middle}
    th{background:#f0f0f0}
    .danger{background:#c00;color:#fff}
    .muted{color:#666;font-size:12px}
    .sticky{position:sticky;left:0;background:#fff;}
  </style>
  <!-- admin matrices & analytics added -->
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <button id="openAdmin" class="btn">ê´€ë¦¬ì</button>
  </div>

  <div class="card">
    <h2>í•™ìƒ í‰ê°€ ì œì¶œ (ì´ë²ˆ ì„¸ì…˜ì— ëª¨ë“  ì¡°ë¥¼ í•œ ë²ˆì— í‰ê°€)</h2>
    <div class="row4">
      <div>
        <label>í•™ë²ˆ</label>
        <input id="studentId" type="text" placeholder="ì˜ˆ: 20010728">
      </div>
      <div>
        <label>ì„¸ì…˜</label>
        <select id="sessionSelect"></select>
      </div>
      <div>
        <label>ë‚´ ì¡°</label>
        <select id="myGroupSelect"></select>
      </div>
      <div>
        <label>ì˜¤ëŠ˜ ì§ˆë¬¸ ê°œìˆ˜</label>
        <input id="questionsCount" type="number" min="0" step="1" placeholder="0" value="0" />
        <div class="muted">ë³¸ì¸ì´ ì˜¤ëŠ˜ ìˆ˜ì—… ì¤‘ í•œ ì§ˆë¬¸ ìˆ˜</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>ëª¨ë“  ì¡° í‰ê°€ ì…ë ¥</h2>
    <div class="muted">ê° ì¡°ì— ëŒ€í•´ 3ê°œ í•­ëª©(ë‚´ìš©/ëª…ë£Œì„±/ìƒí˜¸ì‘ìš©)ì„ 1~5ë¡œ ì„ íƒí•˜ê³ , í•„ìš”í•˜ë©´ ì½”ë©˜íŠ¸ë¥¼ ë‚¨ê¸°ì„¸ìš”. ì œì¶œ ì‹œ ê° ì¡°ë³„ í‰ê°€ê°€ ê°œë³„ ë¬¸ì„œë¡œ ì €ì¥ë©ë‹ˆë‹¤(ê°™ì€ í•™ë²ˆÂ·ì„¸ì…˜Â·ì¡°ë¡œ ì¬ì œì¶œí•˜ë©´ ë®ì–´ì“°ê¸°).</div>
    <div class="muted" style="margin-top:6px">â€» <b>ìê¸° ì¡°ëŠ” ìë™ìœ¼ë¡œ ì œì™¸</b>ë˜ì–´ í‘œì—ì„œ ìˆ¨ê²¨ì§‘ë‹ˆë‹¤.</div>

    <table id="matrixTable" style="margin-top:10px">
      <thead>
        <tr>
          <th class="sticky">í‰ê°€ ëŒ€ìƒ ì¡°</th>
          <th>ë‚´ìš©</th>
          <th>ëª…ë£Œì„±</th>
          <th>ìƒí˜¸ì‘ìš©</th>
          <th>ì½”ë©˜íŠ¸(ì„ íƒ)</th>
        </tr>
      </thead>
      <tbody id="matrixBody"></tbody>
    </table>

    <div style="display:flex;gap:8px;align-items:center;margin-top:12px">
      <button id="submitBtn" class="btn" disabled>ì „ì²´ ì œì¶œ</button>
      <div id="submitMsg" class="muted"></div>
    </div>
  </div>

  <div id="adminPanel" class="card" style="display:none">
    <h2>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h2>
    <div id="adminWarn" class="muted" style="margin-bottom:8px"></div>
    <label>ì„¸ì…˜ ì„ íƒ</label>
    <select id="adminSession"></select>
    <label>ì •ë ¬</label>
    <select id="sortSelect">
      <option value="overall">ì¢…í•©ì ìˆ˜</option>
      <option value="count">ì‘ë‹µìˆ˜</option>
    </select>
    <button id="exportCsvBtn" class="btn">CSV ë‚´ë³´ë‚´ê¸°</button>
    <table>
      <thead><tr id="aggHead"></tr></thead>
      <tbody id="aggBody"></tbody>
    </table>

    <h3>ê°œë³„ ì œì¶œ ë‚´ì—­</h3>
    <table>
      <thead>
        <tr>
          <th>í•™ë²ˆ</th><th>ì„¸ì…˜</th><th>ë‚´ì¡°</th><th>í‰ê°€ì¡°</th>
          <th>ë‚´ìš©</th><th>ëª…ë£Œì„±</th><th>ìƒí˜¸ì‘ìš©</th>
          <th>ì¢…í•©</th><th>ì§ˆë¬¸ìˆ˜</th><th>ì½”ë©˜íŠ¸</th><th>ì‚­ì œ</th>
        </tr>
      </thead>
      <tbody id="submissionsBody"></tbody>
    </table>

    <h3>ê°œì¸ë³„ ì œì¶œ/ì§ˆë¬¸ í˜„í™© (ì„¸ì…˜ ê¸°ì¤€)</h3>
    <table>
      <thead>
        <tr>
          <th>í•™ë²ˆ</th><th>ì œì¶œì—¬ë¶€</th><th>ì§ˆë¬¸ í•©ê³„</th>
        </tr>
      </thead>
      <tbody id="rosterBody"></tbody>
    </table>

    <h3 style="margin-top:16px">ê°œì¸ë³„ ëˆ„ì  ì§ˆë¬¸ í•©ê³„ (ì „ì²´ í•™ê¸°)</h3>
    <table>
      <thead>
        <tr>
          <th>í•™ë²ˆ</th><th>ëˆ„ì  ì§ˆë¬¸</th>
        </tr>
      </thead>
      <tbody id="rosterCumu"></tbody>
    </table>

    <h3 style="margin-top:16px">[ì‹ ê·œ] ë‚ ì§œë³„ í•™ë²ˆë³„ <u>ì œì¶œ ì—¬ë¶€</u> ë§¤íŠ¸ë¦­ìŠ¤</h3>
    <table>
      <thead id="qSubmitHead"></thead>
      <tbody id="qSubmitBody"></tbody>
    </table>

    <h3 style="margin-top:16px">[ì‹ ê·œ] ë‚ ì§œë³„ í•™ë²ˆë³„ <u>ì§ˆë¬¸ ê°œìˆ˜</u> ë§¤íŠ¸ë¦­ìŠ¤</h3>
    <table>
      <thead id="qCountHead"></thead>
      <tbody id="qCountBody"></tbody>
    </table>

    <h3 style="margin-top:16px">[ì‹ ê·œ] ë‚ ì§œë³„ ì¡°ë³„ <u>í‰ê·  ì¢…í•©ì ìˆ˜</u> ë§¤íŠ¸ë¦­ìŠ¤</h3>
    <table>
      <thead id="grpAvgHead"></thead>
      <tbody id="grpAvgBody"></tbody>
    </table>
  </div>
</div>

<!-- ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ -->
<div id="adminModal" class="modal-backdrop">
  <div class="modal">
    <h3>ê´€ë¦¬ì ë¡œê·¸ì¸</h3>
    <label>ë¹„ë°€ë²ˆí˜¸</label>
    <input id="adminPw" type="password">
    <button id="cancelAdmin" class="btn" style="background:#777">ì·¨ì†Œ</button>
    <button id="adminLoginBtn" class="btn">ë¡œê·¸ì¸</button>
    <div id="adminMsg"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
// ====== ìƒìˆ˜/ì„¤ì • ======
const GROUPS=[
  "1ì¡°-GenAIus",
  "2ì¡°-ìš°ë¦¬ë³´ë‹¤ ë‹¤ ë°‘2ì¡°",
  "3ì¡°-Team T-ssue",
  "4ì¡°-A.I.D.",
  "5ì¡°-By5",
  "6ì¡°-Cell4Cure"
];
const CRITERIA=[
 {key:"content",label:"ë‚´ìš©ì˜ ì •í™•ì„±/ê¹Šì´"},
 {key:"clarity",label:"ë°œí‘œ ëª…ë£Œì„±/êµ¬ì„±"},
 {key:"engagement",label:"ì²­ì¤‘ê³¼ì˜ ìƒí˜¸ì‘ìš©"}
];
const ADMIN_PW="1313";
let db=null;

// í—ˆìš©ëœ í•™ë²ˆ ë¦¬ìŠ¤íŠ¸
const VALID_IDS=[
  "20010728","21010621","21010632","21010659","21010676","21010729","21011085","21012803","21013168","22010661","22010678","22010679","22010710","22010719","22010773","22013376","22013497","22013522","23010618","23010649","23010682","23010688","23010694","23010723","23010742","23010746","23010760","23011245","23013448","22013569"
];

// ====== Firebase ì´ˆê¸°í™” ======
function initFirebase(){
  const firebaseConfig={
    apiKey:"AIzaSyCl7Ggf5rwG96nM8f1ZNeDRhUT1X66bPP4",
    authDomain:"ai-gene-cell-therapy.firebaseapp.com",
    projectId:"ai-gene-cell-therapy",
    storageBucket:"ai-gene-cell-therapy.firebasestorage.app",
    messagingSenderId:"245138164213",
    appId:"1:245138164213:web:d78e21880ce0bdf2c1b8bc",
    measurementId:"G-TE3WHRX7SK"
  };
  firebase.initializeApp(firebaseConfig);
  db=firebase.firestore();
}
initFirebase();

// ====== ìœ í‹¸ ======
function $(id){return document.getElementById(id)}
function nowTS(){return new Date().toISOString().slice(0,19).replace('T',' ')}

// ì„¸ì…˜(í•™ìƒ/ê´€ë¦¬ì: 9~12ì›” ëª¨ë“  ëª©ìš”ì¼)
function buildSessions(){
 const sessions=[];const now=new Date();const year=now.getFullYear();
 for(let m=9;m<=12;m++){
  for(let d=1;d<=31;d++){
   const x=new Date(year,m-1,d);
   if(x.getMonth()!==m-1) break;
   if(x.getDay()===4){ sessions.push(`${year}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`); }
  }
 }
 return sessions;
}

// ====== ì´ˆê¸° ë Œë” ======
(function(){
  // í•™ìƒ í¼ ë“œë¡­ë‹¤ìš´ êµ¬ì„±
  const sessSel=$("sessionSelect"),mySel=$("myGroupSelect");
  sessSel.innerHTML=''; mySel.innerHTML='';
  const sessions=buildSessions();
  sessions.sort();
  sessions.forEach(s=>{let o=document.createElement('option');o.value=o.textContent=s;sessSel.appendChild(o)});
  if(sessions.length){ sessSel.value=sessions[sessions.length-1]; }
  GROUPS.forEach(g=>{let o=document.createElement('option');o.value=o.textContent=g;mySel.appendChild(o)});
  mySel.addEventListener('change',renderMatrix);
  sessSel.addEventListener('change',validateForm);
  renderMatrix();

  // ì´ë²¤íŠ¸ ë°”ì¸ë”©
  ["studentId","sessionSelect","myGroupSelect","questionsCount"].forEach(id=>$(id).addEventListener('input',validateForm));
  $("matrixBody").addEventListener('input', validateForm);
})();

function renderMatrix(){
 const body=$("matrixBody"); body.innerHTML='';
 const my=$("myGroupSelect").value;
 GROUPS.forEach(g=>{
   if(my && g===my) return; // ìê¸° ì¡°ëŠ” í‘œì—ì„œ ìˆ¨ê¹€
   const tr=document.createElement('tr');
   const th=document.createElement('td'); th.textContent=g; th.className='sticky'; tr.appendChild(th);
   CRITERIA.forEach(c=>{
     const td=document.createElement('td');
     const sel=document.createElement('select'); sel.dataset.group=g; sel.dataset.key=c.key;
     [1,2,3,4,5].forEach(v=>{const o=document.createElement('option'); o.value=String(v); o.textContent=String(v); sel.appendChild(o)});
     td.appendChild(sel); tr.appendChild(td);
   });
   const tdC=document.createElement('td'); const txt=document.createElement('textarea'); txt.rows=1; txt.dataset.group=g; txt.placeholder='ì„ íƒ'; tdC.appendChild(txt); tr.appendChild(tdC);
   body.appendChild(tr);
 });
 validateForm();
}

function validateForm(){
 const sid=$("studentId").value.trim();
 const sess=$("sessionSelect").value;
 const my=$("myGroupSelect").value;
 const q=$("questionsCount").value;
 const validQ = q!=='' && Number(q)>=0 && Number.isInteger(Number(q));
 const okBasics = sid && sess && my && validQ;
 const allFilled = [...document.querySelectorAll('#matrixBody select')].every(s=> !!s.value);
 $("submitBtn").disabled = !(okBasics && allFilled);
}

// ====== ì €ì¥ ======
async function saveSubmission(row){
 const docId=`${row.session_code}_${row.rater_id}_${row.target_group}`;
 return db.collection('submissions').doc(docId).set(row);
}

// ë¡œì»¬ ì¤‘ë³µí‘œì‹œ í‚¤
function localKey(session, student){ return `submitted_${session}_${student}`; }

$("submitBtn").addEventListener('click', async ()=>{
 const sid=$("studentId").value.trim();
 if(!VALID_IDS.includes(sid)){
   $("submitMsg").textContent="í•™ë²ˆì„ í™•ì¸í•˜ì„¸ìš”.";
   $("submitMsg").style.color="#c00"; return;
 }
 const qn = Number($("questionsCount").value||0);
 if(!(Number.isInteger(qn) && qn>=0)){
   $("submitMsg").textContent="ì§ˆë¬¸ ê°œìˆ˜ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš” (0 ì´ìƒì˜ ì •ìˆ˜).";
   $("submitMsg").style.color="#c00"; return;
 }
 const sess=$("sessionSelect").value;
 const my=$("myGroupSelect").value;

 // ğŸ” ì„œë²„ ì¡°íšŒ ì—†ì´, ë™ì¼ ë¸Œë¼ìš°ì € ê¸°ì¤€ ì¤‘ë³µ í™•ì¸
 const k = localKey(sess, sid);
 if(localStorage.getItem(k)){
   const ok = window.confirm('ì´ë¯¸ ì´ ë¸Œë¼ìš°ì €ì—ì„œ ê°™ì€ ì„¸ì…˜ìœ¼ë¡œ ì œì¶œí–ˆìŠµë‹ˆë‹¤. ë®ì–´ ì”Œìš°ì‹œê² ìŠµë‹ˆê¹Œ?');
   if(!ok){ $("submitMsg").textContent='ì €ì¥ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.'; $("submitMsg").style.color="#c00"; return; }
 }

 const selects=[...document.querySelectorAll('#matrixBody select')];
 const commentsByGroup = Object.fromEntries([...document.querySelectorAll('#matrixBody textarea')].map(t=>[t.dataset.group, t.value]));
 const dataByGroup = {};
 selects.forEach(s=>{
   const g=s.dataset.group, k=s.dataset.key, v=parseInt(s.value,10);
   if(!dataByGroup[g]) dataByGroup[g]={};
   dataByGroup[g][k]=v;
 });

 let saved=0, failed=0; let lastErr='';
 for(const g of GROUPS){
   if(my && g===my) continue; // ìê¸° ì¡°ëŠ” ì €ì¥ ì œì™¸
   const scores=dataByGroup[g]||{};
   const vals = CRITERIA.map(c=> Number(scores[c.key]||0));
   const sum = vals.reduce((a,b)=>a+b,0);
   const overall=(sum/CRITERIA.length).toFixed(2);
   const row={
     timestamp:nowTS(), session_code:sess,
     rater_id:sid, rater_group:my, target_group:g,
     overall, questions_count: qn,
     comment: commentsByGroup[g]||'',
     ...Object.fromEntries(CRITERIA.map(c=> ['c_'+c.key, scores[c.key]||0]))
   };
   try{ await saveSubmission(row); saved++; }
   catch(e){ failed++; lastErr=e.message; }
 }
 if(failed===0){
   localStorage.setItem(k, '1'); // ë¸Œë¼ìš°ì € ë‹¨ìœ„ ì œì¶œí‘œì‹œ
   $("submitMsg").textContent=`ìê¸° ì¡° ì œì™¸, ì œì¶œ ì™„ë£Œ (${saved}ê±´ ì €ì¥, ì§ˆë¬¸ ${qn}ê°œ)`; $("submitMsg").style.color="#0a7";
 }else{
   $("submitMsg").textContent=`ì¼ë¶€ ì €ì¥ ì‹¤íŒ¨: ${failed}ê±´ ì˜¤ë¥˜ (${lastErr}). ê´€ë¦¬ìì—ê²Œ ê¶Œí•œ ì„¤ì •ì„ ìš”ì²­í•˜ì„¸ìš”.`; $("submitMsg").style.color="#c00";
 }
});

// ====== ê´€ë¦¬ì ======
$("openAdmin").addEventListener('click',()=>{$("adminModal").style.display='flex';});
$("cancelAdmin").addEventListener('click',()=>{$("adminModal").style.display='none'});
$("adminLoginBtn").addEventListener('click',async()=>{
 if($("adminPw").value!==ADMIN_PW){$("adminMsg").textContent="ë¹„ë²ˆ ì˜¤ë¥˜";return}
 $("adminModal").style.display='none';$("adminPanel").style.display='block';
 await populateAdminSessions();
 renderAgg();renderSubmissions();renderRosterStatus();
 renderQuestionsMatrices();renderGroupAveragesByDate();
 $("adminSession").addEventListener('change',()=>{renderAgg();renderSubmissions();renderRosterStatus();renderQuestionsMatrices();renderGroupAveragesByDate();});
});

async function safeLoadAll(){
  try{
    const snap=await db.collection('submissions').get();
    return snap.docs.map(d=>({id:d.id,...d.data()}));
  }catch(e){
    $("adminWarn").textContent='ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (Firestore ê·œì¹™: ì½ê¸° í—ˆìš© í•„ìš”)';
    console.warn('[ADMIN] loadAll failed', e);
    return [];
  }
}

async function populateAdminSessions(){
  const adminSel=$("adminSession");
  adminSel.innerHTML='';
  const rows=await safeLoadAll();
  const have = Array.from(new Set(rows.map(r=>r.session_code).filter(Boolean)));
  let sessions = have.length? have : buildSessions();
  sessions.sort();
  sessions.forEach((s)=>{let o=document.createElement('option');o.value=o.textContent=s;adminSel.appendChild(o)});
  if(sessions.length){ adminSel.value = sessions[sessions.length-1]; }
}

async function renderAgg(){
 const sess=$("adminSession").value||buildSessions()[0];
 const rows=(await safeLoadAll()).filter(r=>r.session_code===sess);
 const byGroup={};
 rows.forEach(r=>{
   const g=r.target_group;
   if(!byGroup[g])byGroup[g]={count:0,sum_overall:0,sums:{}};
   byGroup[g].count++;
   byGroup[g].sum_overall+=Number(r.overall);
   CRITERIA.forEach(c=>{
     const key='c_'+c.key;
     byGroup[g].sums[key]=(byGroup[g].sums[key]||0)+Number(r[key]);
   })
 });
 const head=$("aggHead");head.innerHTML='';
 ['ê·¸ë£¹','ì‘ë‹µìˆ˜','ì¢…í•©í‰ê· ',...CRITERIA.map(c=>c.label+' í‰ê· ')].forEach(t=>{let th=document.createElement('th');th.textContent=t;head.appendChild(th)});
 const body=$("aggBody");body.innerHTML='';
 Object.entries(byGroup).forEach(([g,info])=>{
  const avg=(info.sum_overall/info.count).toFixed(2);
  const avgEach=CRITERIA.map(c=>(info.sums['c_'+c.key]/info.count).toFixed(2));
  let tr=document.createElement('tr');
  [g,info.count,avg,...avgEach].forEach(v=>{let td=document.createElement('td');td.textContent=v;tr.appendChild(td)});
  body.appendChild(tr);
 });
}

async function renderSubmissions(){
 const sess=$("adminSession").value||buildSessions()[0];
 const rows=(await safeLoadAll()).filter(r=>r.session_code===sess);
 const body=$("submissionsBody");body.innerHTML='';
 rows.forEach(r=>{
  let tr=document.createElement('tr');
  [r.rater_id,r.session_code,r.rater_group,r.target_group,r.c_content,r.c_clarity,r.c_engagement,r.overall,(r.questions_count??0),r.comment].forEach(v=>{
    let td=document.createElement('td');td.textContent=v;tr.appendChild(td);
  });
  let tdDel=document.createElement('td');
  let btn=document.createElement('button');btn.textContent='ì‚­ì œ';btn.className='btn danger';
  btn.onclick=async()=>{
    try{ await db.collection('submissions').doc(r.id).delete(); }
    catch(e){ $("adminWarn").textContent='ì‚­ì œ ì‹¤íŒ¨: Firestore ê·œì¹™ì—ì„œ ì‚­ì œ í—ˆìš©ì´ í•„ìš”í•©ë‹ˆë‹¤.'; return; }
    renderSubmissions();renderAgg();renderRosterStatus();renderQuestionsMatrices();renderGroupAveragesByDate();
  };
  tdDel.appendChild(btn);tr.appendChild(tdDel);
  body.appendChild(tr);
 });
}

async function renderRosterStatus(){
 const sess=$("adminSession").value||buildSessions()[0];
 const rowsAll=await safeLoadAll();
 const rowsSess=rowsAll.filter(r=>r.session_code===sess);
 
 // --- (A) ì„¸ì…˜ë³„ ì œì¶œ/ì§ˆë¬¸ í•©ê³„: ì§ˆë¬¸ ìˆ˜ëŠ” "í•™ìƒÃ—ì„¸ì…˜" ë‹¹ 1ë²ˆë§Œ ì§‘ê³„ ---
 const byStudent = {};
 VALID_IDS.forEach(id=>{byStudent[id]={submitted:false, questions:0};});
 const seenPerSession = new Set(); // keys: rater_id|session_code (ì´ ì„¸ì…˜ ë‚´ ì¤‘ë³µ ë°©ì§€)
 rowsSess.forEach(r=>{
   const id=r.rater_id; if(!(id in byStudent)) return;
   byStudent[id].submitted = true;
   const key = id+"|"+r.session_code;
   if(!seenPerSession.has(key)){
     byStudent[id].questions += Number(r.questions_count||0);
     seenPerSession.add(key);
   }
 });
 const body=$("rosterBody"); body.innerHTML='';
 VALID_IDS.forEach(id=>{
   const tr=document.createElement('tr');
   const submitted = byStudent[id].submitted ? 'O' : 'X';
   const qsum = byStudent[id].questions;
   [id, submitted, qsum].forEach(v=>{const td=document.createElement('td');td.textContent=v;tr.appendChild(td);});
   body.appendChild(tr);
 });
 
 // --- (B) ì „ì²´ í•™ê¸° ëˆ„ì  ì§ˆë¬¸: ì„¸ì…˜ë§ˆë‹¤ 1ë²ˆë§Œ í•©ì‚° (ê·¸ë£¹ë³„ ì¤‘ë³µ ì œê±°) ---
 const cumu = {}; VALID_IDS.forEach(id=>cumu[id]=0);
 const seenAll = new Set(); // keys: rater_id|session_code (ëª¨ë“  ì„¸ì…˜ ì¤‘ë³µ ë°©ì§€)
 rowsAll.forEach(r=>{
   const id=r.rater_id; if(!(id in cumu)) return;
   const key = id+"|"+r.session_code;
   if(!seenAll.has(key)){
     cumu[id] += Number(r.questions_count||0);
     seenAll.add(key);
   }
 });
 const bodyC=$("rosterCumu"); bodyC.innerHTML='';
 VALID_IDS.forEach(id=>{
   const tr=document.createElement('tr');
   [id, cumu[id]].forEach(v=>{const td=document.createElement('td');td.textContent=v;tr.appendChild(td);});
   bodyC.appendChild(tr);
 });
}

// ====== CSV ë‚´ë³´ë‚´ê¸° ======
function toCSV(rows, headers){
  const needsQuote = /[",\n]/;            // ë”°ì˜´í‘œ, ì½¤ë§ˆ, ì¤„ë°”ê¿ˆ í¬í•¨ ì‹œ ì¸ìš©ë¶€í˜¸ í•„ìš”
  const quoteDbl = /\"/g;                    // " â†’ ""
  const esc = v => { if(v==null) return ""; v=String(v); return needsQuote.test(v) ? '"'+v.replace(quoteDbl,'""')+'"' : v; };
  const lines=[headers.map(esc).join(',')];
  rows.forEach(r=> lines.push(headers.map(h=>esc(r[h])).join(',')));
  return lines.join("\n");
}

$("exportCsvBtn").addEventListener('click', async ()=>{
  const rows = await safeLoadAll();
  if(!rows.length){ $("adminWarn").textContent='CSV ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ì½ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.(ê·œì¹™ í™•ì¸)'; return; }
  const headers = ['timestamp','session_code','rater_id','rater_group','target_group','c_content','c_clarity','c_engagement','overall','questions_count','comment'];
  const csv = toCSV(rows, headers);
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='submissions.csv'; a.click(); URL.revokeObjectURL(url);
});

// ====== ê°„ë‹¨ í…ŒìŠ¤íŠ¸ ======
(function tests(){
  try{
    // CSV ì´ìŠ¤ì¼€ì´í”„ í…ŒìŠ¤íŠ¸ (ì¤„ë°”ê¿ˆ í¬í•¨ ë¬¸ìì—´)
    const tcsv = toCSV(
      [{a:'x', b:'He said \"Hi\"\nnew'}, {a:',comma', b:'plain'}],
      ["a","b"]
    );
    console.assert(tcsv.split("\n").length===3, 'CSV line count');

    // ë”°ì˜´í‘œ/ì½¤ë§ˆ/ì¤„ë°”ê¿ˆ í˜¼í•© ì¼€ì´ìŠ¤ ì¶”ê°€ í…ŒìŠ¤íŠ¸
    const mixed = toCSV(
      [{x:'\"quote\"', y:'one,two\nthree'}],
      ["x","y"]
    );
    const parts = mixed.split("\n");
    console.assert(parts.length===2, 'CSV 2 lines');
    console.assert(/""quote""/.test(parts[1]), 'quotes doubled');
    console.assert(/"one,two\nthree"/.test(parts[1]), 'newline quoted');

    // ì„¸ì…˜ ë¹Œë” ìµœì†Œ 1ê°œ ì´ìƒ
    const all = buildSessions();
    console.assert(all.length>0, 'buildSessions has dates');

    // ë¬¸ì„œ í‚¤ êµ¬ì„±
    const docId = `${'2025-09-04'}_${'20010728'}_${'1ì¡°-GenAIus'}`;
    console.assert(typeof docId==='string' && docId.includes('GenAIus'),'docId format');

    // ì§ˆë¬¸ í•©ê³„ dedup í…ŒìŠ¤íŠ¸: ë™ì¼ í•™ìƒ/ì„¸ì…˜ ë¬¸ì„œ 5ê°œ(ê·¸ë£¹ë³„)ì—¬ë„ ì§ˆë¬¸ì€ 1íšŒë§Œ ì§‘ê³„
    const mock = [1,2,3,4,5].map(i=>({rater_id:'20010728', session_code:'2025-09-04', questions_count:3}));
    let seen=new Set(), sum=0;
    mock.forEach(r=>{const k=r.rater_id+'|'+r.session_code; if(!seen.has(k)){sum+=r.questions_count; seen.add(k);} });
    console.assert(sum===3,'questions dedup per session');

    console.log('[TEST] OK');
  }catch(e){ console.warn('[TEST] FAILED', e); }
})();

// ====== ì‹ ê·œ: ë‚ ì§œë³„ í•™ë²ˆë³„ ì œì¶œ/ì§ˆë¬¸ ë§¤íŠ¸ë¦­ìŠ¤, ë‚ ì§œë³„ ì¡°ë³„ í‰ê·  ======
function getSortedSessionsFromRows(rows){
  const set=new Set(rows.map(r=>r.session_code).filter(Boolean));
  const list=[...set];
  list.sort();
  return list;
}
function firstClassThursday(year){
  // í•™ê¸° ê¸°ì¤€: 9~12ì›” ì¤‘ "ê°€ì¥ ì´ë¥¸ ëª©ìš”ì¼"ì„ 1ì£¼ì°¨ ê¸°ì¤€ì¼ë¡œ ì‚¬ìš©
  for(let m=9;m<=12;m++){
    for(let d=1;d<=7;d++){
      const dt=new Date(year, m-1, d);
      if(dt.getMonth()!==m-1) break;
      if(dt.getDay()===4) return dt; // ëª©ìš”ì¼
    }
  }
  // ì•ˆì „ì¥ì¹˜: í˜¹ì‹œ ìœ„ì—ì„œ ëª» ì°¾ìœ¼ë©´ 9/01 ë°˜í™˜
  return new Date(year,8,1);
}
function getWeekIndex(dateStr){
  // dateStr: YYYY-MM-DD â†’ í•´ë‹¹ ë…„ë„ì˜ 9~12ì›” í•™ê¸° ë‚´ ì£¼ì°¨(ì²« ëª©ìš”ì¼=1ì£¼ì°¨)
  const [y,m,d]=dateStr.split('-').map(Number);
  const year=y;
  const target=new Date(year, m-1, d);
  const start=firstClassThursday(year);
  // start ì´ì „ ë‚ ì§œë¼ë©´ 0 ì²˜ë¦¬
  if(target < start) return 0;
  // start ê¸°ì¤€ìœ¼ë¡œ ëª‡ ì£¼ê°€ ì§€ë‚¬ëŠ”ì§€ ê³„ì‚° (ëª©ìš”ì¼ ê°„ê²©)
  const diffDays=Math.floor((target - start)/(1000*60*60*24));
  const weeks=Math.floor(diffDays/7);
  return weeks+1; // 1ì£¼ì°¨ë¶€í„° ì‹œì‘
}
function labelSessions(sessions){
  return sessions.map((s)=>{ const [y,m,d]=s.split('-').map(Number); const w=getWeekIndex(s); return `${m}ì›” ${d}ì¼(${w}ì£¼ì°¨)`; });
}
async function renderQuestionsMatrices(){
  const rows=await safeLoadAll();
  if(!rows.length){
    $("qSubmitHead").innerHTML=''; $("qSubmitBody").innerHTML='';
    $("qCountHead").innerHTML=''; $("qCountBody").innerHTML='';
    return;
  }
  const sessions=getSortedSessionsFromRows(rows);
  const headers = ['í•™ë²ˆ', ...labelSessions(sessions)];
  $("qSubmitHead").innerHTML='<tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr>';
  $("qSubmitBody").innerHTML='';
  $("qCountHead").innerHTML='<tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr>';
  $("qCountBody").innerHTML='';

  const mapQS=new Map(); // student|session -> {submitted,q}
  rows.forEach(r=>{
    const key = r.rater_id+'|'+r.session_code;
    if(!mapQS.has(key)) mapQS.set(key,{submitted:true,q:Number(r.questions_count||0)});
  });

  VALID_IDS.forEach(stu=>{
    const tds=[`<td>${stu}</td>`];
    sessions.forEach(s=>{ const k=stu+'|'+s; const v=mapQS.get(k); tds.push(`<td>${v? 'O':'X'}</td>`); });
    const tr=document.createElement('tr'); tr.innerHTML=tds.join(''); $("qSubmitBody").appendChild(tr);
  });

  VALID_IDS.forEach(stu=>{
    const tds=[`<td>${stu}</td>`];
    sessions.forEach(s=>{ const k=stu+'|'+s; const v=mapQS.get(k); tds.push(`<td>${v? v.q: 0}</td>`); });
    const tr=document.createElement('tr'); tr.innerHTML=tds.join(''); $("qCountBody").appendChild(tr);
  });
}

async function renderGroupAveragesByDate(){
  const rows=await safeLoadAll();
  if(!rows.length){ $("grpAvgHead").innerHTML=''; $("grpAvgBody").innerHTML=''; return; }
  const sessions=getSortedSessionsFromRows(rows);
  const headers=['ê·¸ë£¹', ...labelSessions(sessions)];
  $("grpAvgHead").innerHTML='<tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr>';
  $("grpAvgBody").innerHTML='';

  const groupAvg={}; sessions.forEach(s=> groupAvg[s]={});
  rows.forEach(r=>{
    const s=r.session_code, g=r.target_group; if(!s||!g) return;
    if(!groupAvg[s][g]) groupAvg[s][g]={sum:0,count:0};
    groupAvg[s][g].sum += Number(r.overall);
    groupAvg[s][g].count += 1;
  });
  GROUPS.forEach(g=>{
    const tds=[`<td>${g}</td>`];
    sessions.forEach(s=>{
      const info=groupAvg[s][g];
      const val = info && info.count ? (info.sum/info.count).toFixed(2) : '';
      tds.push(`<td>${val}</td>`);
    });
    const tr=document.createElement('tr'); tr.innerHTML=tds.join(''); $("grpAvgBody").appendChild(tr);
  });
}

// ====== í…ŒìŠ¤íŠ¸ ì¶”ê°€ ======
(function extraTests(){
  try{
    // ì£¼ì°¨ ë¼ë²¨ë§ ê³ ì • í…ŒìŠ¤íŠ¸: 9/4=1ì£¼ì°¨, 9/18=3ì£¼ì°¨, 10/9=6ì£¼ì°¨ (2025ë…„ ê¸°ì¤€)
    const w1 = getWeekIndex('2025-09-04');
    const w3 = getWeekIndex('2025-09-18');
    const w6 = getWeekIndex('2025-10-09');
    console.assert(w1===1 && w3===3 && w6===6, `weekIndex mapping wrong: ${w1},${w3},${w6}`);

    const labels = labelSessions(['2025-09-04','2025-09-11']);
    console.assert(labels[0].includes('9ì›”') && labels[0].includes('1ì£¼ì°¨'),'labelSessions ok');

    const mock=[
      {session_code:'2025-09-04', target_group:'1ì¡°-GenAIus', overall:4},
      {session_code:'2025-09-04', target_group:'1ì¡°-GenAIus', overall:2},
      {session_code:'2025-09-11', target_group:'1ì¡°-GenAIus', overall:5}
    ];
    const sess=getSortedSessionsFromRows(mock);
    console.assert(sess.length===2,'getSortedSessionsFromRows len');
  }catch(e){ console.warn('[EXT TEST] FAILED', e); }
})();
</script>
</body>
</html>
