<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>조별 상대평가 · 전체 조 일괄 평가 · 관리자 통계</title>
  <style>
    body{font-family:sans-serif;margin:20px;background:#fafafa;color:#111}
    .wrap{max-width:1100px;margin:0 auto;}
    .card{background:#fff;border:1px solid #ccc;border-radius:12px;padding:16px;margin-bottom:16px}
    label{font-weight:600;display:block;margin:6px 0}
    input,select,textarea{padding:8px;border:1px solid #ccc;border-radius:8px}
    input#studentId{width:140px;}
    input#questionsCount{width:120px;text-align:right;}
    select,textarea{width:100%}
    .btn{padding:8px 14px;border-radius:8px;border:none;background:#333;color:#fff;font-weight:600;cursor:pointer}
    .btn[disabled]{background:#999}
    .row4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px}
    .topbar{position:fixed;top:10px;right:10px}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:#fff;padding:20px;border-radius:12px;width:320px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #ddd;padding:8px;text-align:center;vertical-align:middle}
    th{background:#f0f0f0}
    .danger{background:#c00;color:#fff}
    .muted{color:#666;font-size:12px}
    .sticky{position:sticky;left:0;background:#fff;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <button id="openAdmin" class="btn">관리자</button>
  </div>

  <div class="card">
    <h2>학생 평가 제출 (이번 세션에 모든 조를 한 번에 평가)</h2>
    <div class="row4">
      <div>
        <label>학번</label>
        <input id="studentId" type="text" placeholder="예: 20010728">
      </div>
      <div>
        <label>세션</label>
        <select id="sessionSelect"></select>
      </div>
      <div>
        <label>내 조</label>
        <select id="myGroupSelect"></select>
      </div>
      <div>
        <label>오늘 질문 개수</label>
        <input id="questionsCount" type="number" min="0" step="1" placeholder="0" value="0" />
        <div class="muted">본인이 오늘 수업 중 한 질문 수</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>모든 조 평가 입력</h2>
    <div class="muted">각 조에 대해 3개 항목(내용/명료성/상호작용)을 1~5로 선택하고, 필요하면 코멘트를 남기세요. 제출 시 각 조별 평가가 개별 문서로 저장됩니다(같은 학번·세션·조로 재제출하면 덮어쓰기).</div>
    <div class="muted" style="margin-top:6px">※ <b>자기 조는 자동으로 제외</b>되어 표에서 숨겨집니다.</div>

    <table id="matrixTable" style="margin-top:10px">
      <thead>
        <tr>
          <th class="sticky">평가 대상 조</th>
          <th>내용</th>
          <th>명료성</th>
          <th>상호작용</th>
          <th>코멘트(선택)</th>
        </tr>
      </thead>
      <tbody id="matrixBody"></tbody>
    </table>

    <div style="display:flex;gap:8px;align-items:center;margin-top:12px">
      <button id="submitBtn" class="btn" disabled>전체 제출</button>
      <div id="submitMsg" class="muted"></div>
    </div>
  </div>

  <div id="adminPanel" class="card" style="display:none">
    <h2>관리자 대시보드</h2>
    <div id="adminWarn" class="muted" style="margin-bottom:8px"></div>
    <label>세션 선택</label>
    <select id="adminSession"></select>
    <label>정렬</label>
    <select id="sortSelect">
      <option value="overall">종합점수</option>
      <option value="count">응답수</option>
    </select>
    <button id="exportCsvBtn" class="btn">CSV 내보내기</button>
    <table>
      <thead><tr id="aggHead"></tr></thead>
      <tbody id="aggBody"></tbody>
    </table>

    <h3>개별 제출 내역</h3>
    <table>
      <thead>
        <tr>
          <th>학번</th><th>세션</th><th>내조</th><th>평가조</th>
          <th>내용</th><th>명료성</th><th>상호작용</th>
          <th>종합</th><th>질문수</th><th>코멘트</th><th>삭제</th>
        </tr>
      </thead>
      <tbody id="submissionsBody"></tbody>
    </table>

    <h3>개인별 제출/질문 현황 (세션 기준)</h3>
    <table>
      <thead>
        <tr>
          <th>학번</th><th>제출여부</th><th>질문 합계</th>
        </tr>
      </thead>
      <tbody id="rosterBody"></tbody>
    </table>

    <h3 style="margin-top:16px">개인별 누적 질문 합계 (전체 학기)</h3>
    <table>
      <thead>
        <tr>
          <th>학번</th><th>누적 질문</th>
        </tr>
      </thead>
      <tbody id="rosterCumu"></tbody>
    </table>
  </div>
</div>

<!-- 관리자 로그인 모달 -->
<div id="adminModal" class="modal-backdrop">
  <div class="modal">
    <h3>관리자 로그인</h3>
    <label>비밀번호</label>
    <input id="adminPw" type="password">
    <button id="cancelAdmin" class="btn" style="background:#777">취소</button>
    <button id="adminLoginBtn" class="btn">로그인</button>
    <div id="adminMsg"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
// 여기에 기존 JS 로직 유지 (권한점검 관련 부분은 제거됨)
</script>
</body>
</html>
