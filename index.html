<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>조별 상대평가 · 전체 조 일괄 평가 · 관리자 통계</title>
  <style>
    body{font-family:sans-serif;margin:20px;background:#fafafa;color:#111}
    .wrap{max-width:1100px;margin:0 auto;}
    .card{background:#fff;border:1px solid #ccc;border-radius:12px;padding:16px;margin-bottom:16px}
    label{font-weight:600;display:block;margin:6px 0}
    input,select,textarea{padding:8px;border:1px solid #ccc;border-radius:8px}
    input#studentId{width:140px;}
    input#questionsCount{width:120px;text-align:right;}
    select,textarea{width:100%}
    .btn{padding:8px 14px;border-radius:8px;border:none;background:#333;color:#fff;font-weight:600;cursor:pointer}
    .btn[disabled]{background:#999}
    .row4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px}
    .topbar{position:fixed;top:10px;right:10px}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:#fff;padding:20px;border-radius:12px;width:300px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #ddd;padding:8px;text-align:center;vertical-align:middle}
    th{background:#f0f0f0}
    .danger{background:#c00;color:#fff}
    .muted{color:#666;font-size:12px}
    .sticky{position:sticky;left:0;background:#fff;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <button id="openAdmin" class="btn">관리자</button>
  </div>

  <div class="card">
    <h2>학생 평가 제출 (이번 세션에 모든 조를 한 번에 평가)</h2>
    <div class="row4">
      <div>
        <label>학번</label>
        <input id="studentId" type="text" placeholder="예: 20010728">
      </div>
      <div>
        <label>세션</label>
        <select id="sessionSelect"></select>
      </div>
      <div>
        <label>내 조</label>
        <select id="myGroupSelect"></select>
      </div>
      <div>
        <label>오늘 질문 개수</label>
        <input id="questionsCount" type="number" min="0" step="1" placeholder="0" value="0" />
        <div class="muted">본인이 오늘 수업 중 한 질문 수</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>모든 조 평가 입력</h2>
    <div class="muted">각 조에 대해 3개 항목(내용/명료성/상호작용)을 1~5로 선택하고, 필요하면 코멘트를 남기세요. 제출 시 각 조별 평가가 개별 문서로 저장됩니다(같은 학번·세션·조로 재제출하면 덮어쓰기).</div>
    <div class="muted" style="margin-top:6px">※ <b>자기 조는 자동으로 제외</b>되어 표에서 숨겨집니다.</div>

    <table id="matrixTable" style="margin-top:10px">
      <thead>
        <tr>
          <th class="sticky">평가 대상 조</th>
          <th>내용</th>
          <th>명료성</th>
          <th>상호작용</th>
          <th>코멘트(선택)</th>
        </tr>
      </thead>
      <tbody id="matrixBody"></tbody>
    </table>

    <div style="display:flex;gap:8px;align-items:center;margin-top:12px">
      <button id="submitBtn" class="btn" disabled>전체 제출</button>
      <div id="submitMsg" class="muted"></div>
    </div>
  </div>

  <div id="adminPanel" class="card" style="display:none">
    <h2>관리자 대시보드</h2>
    <label>세션 선택</label>
    <select id="adminSession"></select>
    <label>정렬</label>
    <select id="sortSelect">
      <option value="overall">종합점수</option>
      <option value="count">응답수</option>
    </select>
    <button id="exportCsvBtn" class="btn">CSV 내보내기</button>
    <table>
      <thead><tr id="aggHead"></tr></thead>
      <tbody id="aggBody"></tbody>
    </table>

    <h3>개별 제출 내역</h3>
    <table>
      <thead>
        <tr>
          <th>학번</th><th>세션</th><th>내조</th><th>평가조</th>
          <th>내용</th><th>명료성</th><th>상호작용</th>
          <th>종합</th><th>질문수</th><th>코멘트</th><th>삭제</th>
        </tr>
      </thead>
      <tbody id="submissionsBody"></tbody>
    </table>

    <h3>개인별 제출/질문 현황 (세션 기준)</h3>
    <table>
      <thead>
        <tr>
          <th>학번</th><th>제출여부</th><th>질문 합계</th>
        </tr>
      </thead>
      <tbody id="rosterBody"></tbody>
    </table>
  </div>
</div>

<!-- 관리자 로그인 모달 -->
<div id="adminModal" class="modal-backdrop">
  <div class="modal">
    <h3>관리자 로그인</h3>
    <label>비밀번호</label>
    <input id="adminPw" type="password">
    <button id="cancelAdmin" class="btn" style="background:#777">취소</button>
    <button id="adminLoginBtn" class="btn">로그인</button>
    <div id="adminMsg"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
// ====== 상수/설정 ======
const GROUPS=[
  "1조-GenAIus",
  "2조-우리보다 다 밑2조",
  "3조-Team T-ssue",
  "4조-A.I.D.",
  "5조-By5",
  "6조-Cell4Cure"
];
const CRITERIA=[
 {key:"content",label:"내용의 정확성/깊이"},
 {key:"clarity",label:"발표 명료성/구성"},
 {key:"engagement",label:"청중과의 상호작용"}
];
const ADMIN_PW="1313";
let db=null;

// 허용된 학번 리스트
const VALID_IDS=[
  "20010728","21010621","21010632","21010659","21010676","21010729","21011085","21012803","21013168","22010661","22010678","22010679","22010710","22010719","22010773","22013376","22013497","22013522","23010618","23010649","23010682","23010688","23010694","23010723","23010742","23010746","23010760","23011245","23013448"
];

// ====== Firebase 초기화 ======
function initFirebase(){
 const firebaseConfig={
  apiKey:"AIzaSyCl7Ggf5rwG96nM8f1ZNeDRhUT1X66bPP4",
  authDomain:"ai-gene-cell-therapy.firebaseapp.com",
  projectId:"ai-gene-cell-therapy",
  storageBucket:"ai-gene-cell-therapy.firebasestorage.app",
  messagingSenderId:"245138164213",
  appId:"1:245138164213:web:d78e21880ce0bdf2c1b8bc",
  measurementId:"G-TE3WHRX7SK"
 };
 firebase.initializeApp(firebaseConfig);
 db=firebase.firestore();
}
initFirebase();

// ====== 유틸 ======
function $(id){return document.getElementById(id)}
function nowTS(){return new Date().toISOString().slice(0,19).replace('T',' ')}

// 세션(학생용: 오늘 이후 목요일)
function buildSessions(){
 const sessions=[];const now=new Date();const year=now.getFullYear();const todayMid=new Date(year,now.getMonth(),now.getDate());
 for(let m=9;m<=12;m++){
  for(let d=1;d<=31;d++){
   const x=new Date(year,m-1,d);
   if(x.getMonth()!==m-1) break;
   if(x.getDay()===4){
    const xMid=new Date(year,m-1,d);
    if(xMid>=todayMid){ sessions.push(`${year}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`); }
   }
  }
 }
 return sessions;
}
// 세션(관리자용: 과거 포함 9~12월 모든 목요일)
function buildSessionsAll(){
 const sessions=[];const now=new Date();const year=now.getFullYear();
 for(let m=9;m<=12;m++){
  for(let d=1;d<=31;d++){
   const x=new Date(year,m-1,d);
   if(x.getMonth()!==m-1) break;
   if(x.getDay()===4){ sessions.push(`${year}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`); }
  }
 }
 return sessions;
}

// ====== 초기 렌더 ======
(function(){
 const sessSel=$("sessionSelect"),mySel=$("myGroupSelect");
 const sessions=buildSessions();
 sessions.forEach(s=>{let o=document.createElement('option');o.value=o.textContent=s;sessSel.appendChild(o)});
 GROUPS.forEach(g=>{let o=document.createElement('option');o.value=o.textContent=g;mySel.appendChild(o)});
 mySel.addEventListener('change',renderMatrix);
 renderMatrix();
})();

function renderMatrix(){
 const body=$("matrixBody"); body.innerHTML='';
 const my=$("myGroupSelect").value;
 GROUPS.forEach(g=>{
   if(my && g===my) return; // 자기 조는 표에서 숨김
   const tr=document.createElement('tr');
   const th=document.createElement('td'); th.textContent=g; th.className='sticky'; tr.appendChild(th);
   CRITERIA.forEach(c=>{
     const td=document.createElement('td');
     const sel=document.createElement('select'); sel.dataset.group=g; sel.dataset.key=c.key;
     [1,2,3,4,5].forEach(v=>{const o=document.createElement('option'); o.value=String(v); o.textContent=String(v); sel.appendChild(o)});
     td.appendChild(sel); tr.appendChild(td);
   });
   const tdC=document.createElement('td'); const txt=document.createElement('textarea'); txt.rows=1; txt.dataset.group=g; txt.placeholder='선택'; tdC.appendChild(txt); tr.appendChild(tdC);
   body.appendChild(tr);
 });
 validateForm();
}

function validateForm(){
 const sid=$("studentId").value.trim();
 const sess=$("sessionSelect").value;
 const my=$("myGroupSelect").value;
 const q=$("questionsCount").value;
 const validQ = q!=='' && Number(q)>=0 && Number.isInteger(Number(q));
 const okBasics = sid && sess && my && validQ;
 const allFilled = [...document.querySelectorAll('#matrixBody select')].every(s=> !!s.value);
 $("submitBtn").disabled = !(okBasics && allFilled);
}
["studentId","sessionSelect","myGroupSelect","questionsCount"].forEach(id=>$(id).addEventListener('input',validateForm));
$("matrixBody").addEventListener('input', validateForm);

// ====== 저장 ======
async function saveSubmission(row){
 const docId=`${row.session_code}_${row.rater_id}_${row.target_group}`;
 await db.collection('submissions').doc(docId).set(row);
}

$("submitBtn").addEventListener('click', async ()=>{
 const sid=$("studentId").value.trim();
 if(!VALID_IDS.includes(sid)){
   $("submitMsg").textContent="학번을 확인하세요.";
   $("submitMsg").style.color="#c00"; return;
 }
 const qn = Number($("questionsCount").value||0);
 if(!(Number.isInteger(qn) && qn>=0)){
   $("submitMsg").textContent="질문 개수를 올바르게 입력하세요 (0 이상의 정수).";
   $("submitMsg").style.color="#c00"; return;
 }
 const sess=$("sessionSelect").value;
 const my=$("myGroupSelect").value;

 const selects=[...document.querySelectorAll('#matrixBody select')];
 const commentsByGroup = Object.fromEntries([...document.querySelectorAll('#matrixBody textarea')].map(t=>[t.dataset.group, t.value]));
 const dataByGroup = {};
 selects.forEach(s=>{
   const g=s.dataset.group, k=s.dataset.key, v=parseInt(s.value,10);
   if(!dataByGroup[g]) dataByGroup[g]={};
   dataByGroup[g][k]=v;
 });

 let saved=0, failed=0; let lastErr='';
 for(const g of GROUPS){
   if(my && g===my) continue; // 자기 조는 저장 제외
   const scores=dataByGroup[g]||{};
   const vals = CRITERIA.map(c=> Number(scores[c.key]||0));
   const sum = vals.reduce((a,b)=>a+b,0);
   const overall=(sum/CRITERIA.length).toFixed(2);
   const row={
     timestamp:nowTS(), session_code:sess,
     rater_id:sid, rater_group:my, target_group:g,
     overall, questions_count: qn,
     comment: commentsByGroup[g]||'',
     ...Object.fromEntries(CRITERIA.map(c=> ['c_'+c.key, scores[c.key]||0]))
   };
   try{ await saveSubmission(row); saved++; }catch(e){ failed++; lastErr=e.message; }
 }
 if(failed===0){
   $("submitMsg").textContent=`자기 조 제외, 제출 완료 (${saved}건 저장, 질문 ${qn}개)`; $("submitMsg").style.color="#0a7";
 }else{
   $("submitMsg").textContent=`일부 저장 실패: ${failed}건 오류 (${lastErr})`; $("submitMsg").style.color="#c00";
 }
});

// ====== 관리자 ======
$("openAdmin").addEventListener('click',()=>{$("adminModal").style.display='flex';});
$("cancelAdmin").addEventListener('click',()=>{$("adminModal").style.display='none'});
$("adminLoginBtn").addEventListener('click',async()=>{
 if($("adminPw").value!==ADMIN_PW){$("adminMsg").textContent="비번 오류";return}
 $("adminModal").style.display='none';$("adminPanel").style.display='block';
 await populateAdminSessions();
 renderAgg();renderSubmissions();renderRosterStatus();
 $("adminSession").addEventListener('change',()=>{renderAgg();renderSubmissions();renderRosterStatus();});
});

async function populateAdminSessions(){
  const adminSel=$("adminSession");
  adminSel.innerHTML='';
  const rows=await loadAll();
  const have = Array.from(new Set(rows.map(r=>r.session_code).filter(Boolean)));
  let sessions = have.length? have : buildSessionsAll();
  sessions.sort();
  sessions.forEach(s=>{let o=document.createElement('option');o.value=o.textContent=s;adminSel.appendChild(o)});
  if(sessions.length){ adminSel.value = sessions[sessions.length-1]; }
}

async function loadAll(){
  const snap=await db.collection('submissions').get();
  return snap.docs.map(d=>({id:d.id,...d.data()}));
}

async function renderAgg(){
 const sess=$("adminSession").value||buildSessions()[0];
 const rows=(await loadAll()).filter(r=>r.session_code===sess);
 const byGroup={};
 rows.forEach(r=>{
   const g=r.target_group;
   if(!byGroup[g])byGroup[g]={count:0,sum_overall:0,sums:{}};
   byGroup[g].count++;
   byGroup[g].sum_overall+=Number(r.overall);
   CRITERIA.forEach(c=>{
     const key='c_'+c.key;
     byGroup[g].sums[key]=(byGroup[g].sums[key]||0)+Number(r[key]);
   })
 });
 const head=$("aggHead");head.innerHTML='';
 ['그룹','응답수','종합평균',...CRITERIA.map(c=>c.label+' 평균')].forEach(t=>{let th=document.createElement('th');th.textContent=t;head.appendChild(th)});
 const body=$("aggBody");body.innerHTML='';
 Object.entries(byGroup).forEach(([g,info])=>{
  const avg=(info.sum_overall/info.count).toFixed(2);
  const avgEach=CRITERIA.map(c=>(info.sums['c_'+c.key]/info.count).toFixed(2));
  let tr=document.createElement('tr');
  [g,info.count,avg,...avgEach].forEach(v=>{let td=document.createElement('td');td.textContent=v;tr.appendChild(td)});
  body.appendChild(tr);
 });
}

async function renderSubmissions(){
 const sess=$("adminSession").value||buildSessions()[0];
 const rows=(await loadAll()).filter(r=>r.session_code===sess);
 const body=$("submissionsBody");body.innerHTML='';
 rows.forEach(r=>{
  let tr=document.createElement('tr');
  [r.rater_id,r.session_code,r.rater_group,r.target_group,r.c_content,r.c_clarity,r.c_engagement,r.overall,(r.questions_count??0),r.comment].forEach(v=>{
    let td=document.createElement('td');td.textContent=v;tr.appendChild(td);
  });
  let tdDel=document.createElement('td');
  let btn=document.createElement('button');btn.textContent='삭제';btn.className='btn danger';
  btn.onclick=async()=>{await db.collection('submissions').doc(r.id).delete();renderSubmissions();renderAgg();renderRosterStatus();};
  tdDel.appendChild(btn);tr.appendChild(tdDel);
  body.appendChild(tr);
 });
}

async function renderRosterStatus(){
 const sess=$("adminSession").value||buildSessions()[0];
 const rows=(await loadAll()).filter(r=>r.session_code===sess);
 const byStudent = {};
 VALID_IDS.forEach(id=>{byStudent[id]={submitted:false, questions:0};});
 rows.forEach(r=>{
   const id=r.rater_id; if(!(id in byStudent)) return;
   byStudent[id].submitted = true;
   byStudent[id].questions += Number(r.questions_count||0);
 });
 const body=$("rosterBody"); body.innerHTML='';
 VALID_IDS.forEach(id=>{
   const tr=document.createElement('tr');
   const submitted = byStudent[id].submitted ? 'O' : 'X';
   const qsum = byStudent[id].questions;
   [id, submitted, qsum].forEach(v=>{const td=document.createElement('td');td.textContent=v;tr.appendChild(td);});
   body.appendChild(tr);
 });
}

// ====== CSV 내보내기 ======
function toCSV(rows, headers){
  const needsQuote = /[",\n]/;
  const quoteDbl = /"/g;
  const esc = v => { if(v==null) return ""; v=String(v); return needsQuote.test(v) ? '"'+v.replace(quoteDbl,'""')+'"' : v; };
  const lines=[headers.map(esc).join(',')];
  rows.forEach(r=> lines.push(headers.map(h=>esc(r[h])).join(',')));
  return lines.join("\n");
}

$("exportCsvBtn").addEventListener('click', async ()=>{
  const rows = await loadAll();
  const headers = ['timestamp','session_code','rater_id','rater_group','target_group','c_content','c_clarity','c_engagement','overall','questions_count','comment'];
  const csv = toCSV(rows, headers);
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='submissions.csv'; a.click(); URL.revokeObjectURL(url);
});

// ====== 간단 테스트 ======
(function tests(){
  try{
    // CSV 이스케이프 테스트
    const tcsv = toCSV([{a:'x',b:'He said "Hi"\nnew'},{a:',comma',b:'plain'}],["a","b"]);
    console.assert(tcsv.split("\n").length===3, 'CSV line count');
    // 세션 빌더 (관리자) 최소 1개 이상
    const all = buildSessionsAll();
    console.assert(all.length>0, 'buildSessionsAll has dates');
    // 문서 키 구성
    const docId = `${'2025-09-04'}_${'20010728'}_${'1조-GenAIus'}`;
    console.assert(typeof docId==='string' && docId.includes('GenAIus'),'docId format');
    console.log('[TEST] OK');
  }catch(e){ console.warn('[TEST] FAILED', e); }
})();
</script>
</body>
</html>
